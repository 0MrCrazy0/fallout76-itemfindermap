<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Fallout 76 Item Finder v30</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Courier New', monospace; margin: 20px; background-color: #0a2a2a; color: #00ff00; overflow-x: hidden; }
        h1 { color: #00ff00; text-align: center; text-shadow: 0 0 10px #00ff00; font-size: 2.2em; margin-bottom: 12px; }
        #map { height: 750px; border: 2px solid #00ff00; margin-bottom: 20px; box-shadow: 0 0 15px #00ff00; background-color: #000000; position: relative; }
        .controls { margin-bottom: 20px; text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        input[type="text"], select { padding: 8px; width: 100%; max-width: 200px; box-sizing: border-box; border: 2px solid #00ff00; border-radius: 0; background-color: #1a3c34; color: #00ff00; font-family: 'Courier New', monospace; }
        #combinedSearch { max-width: 250px; transition: background-color 0.3s, box-shadow 0.3s; }
        #combinedSearch.grid-highlight, #combinedSearch.item-highlight { background-color: #0a3a0a !important; box-shadow: 0 0 15px #00ff00, inset 0 0 10px rgba(0, 255, 0, 0.3); animation: pulseSearch 1.5s ease-out; }
        @keyframes pulseSearch { 0%, 100% { box-shadow: 0 0 15px #00ff00, inset 0 0 10px rgba(0, 255, 0, 0.3); } 50% { box-shadow: 0 0 25px #00ff00, inset 0 0 15px rgba(0, 0, 0.5); } }
        button { padding: 8px 16px; width: 100%; max-width: 200px; box-sizing: border-box; background-color: #1a3c34; color: #00ff00; border: 2px solid #00ff00; border-radius: 0; cursor: pointer; font-family: 'Courier New', monospace; transition: background-color 0.3s; margin: 5px; }
        button:hover { background-color: #00ff00; color: #0a2a2a; }
        button.reset-btn { background-color: #F7615E !important; color: #000 !important; font-weight: 700; }
        p { max-width: 800px; margin: 0 auto 20px; text-align: center; text-shadow: 0 0 5px #00ff00; }
        #tableContainer { width: 100%; max-width: 1000px; margin: 0 auto; overflow-x: auto; overflow-y: hidden; }
        #locationsTable { width: 100%; max-width: 100%; margin: 10px 0; border-collapse: separate; border-spacing: 0 8px; border: 2px solid #00ff00; }
        #locationsTable th, #locationsTable td { border: 2px solid #00ff00; padding: 12px; text-align: left; background-color: #1a3c34; color: #00ff00; }
        #locationsTable th { background-color: #0a2a2a; position: sticky; top: 0; z-index: 10; }
        #locationsTable tr:hover { background-color: #2a4c44; cursor: pointer; }
        #locationsTable tr.glowing { background-color: rgba(0, 255, 0, 0.15); border: 2px solid #00ff00; box-shadow: 0 0 15px #00ff00, 0 0 30px #00ff00; }
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0, 42, 42, 0.8); }
        .modal-content { background-color: #1a3c34; margin: 8% auto; padding: 16px; border: 2px solid #00ff00; width: 100%; max-width: 360px; box-sizing: border-box; border-radius: 0; color: #00ff00; font-family: 'Courier New', monospace; overflow-y: auto; max-height: 80vh; -webkit-overflow-scrolling: touch; }
        .close { color: #00ff00; float: right; font-size: 24px; font-weight: bold; line-height: 1; cursor: pointer; }
        .close:hover { color: #0a2a2a; }
        label { display: block; margin: 8px 0 4px; }
        textarea, input[type="text"] { width: 100%; padding: 8px; border: 2px solid #00ff00; border-radius: 0; background-color: #0a2a2a; color: #00ff00; font-family: 'Courier New', monospace; box-sizing: border-box; }
        textarea { height: 120px; }
        body.modal-open { overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .custom-icon { display: flex; align-items: center; justify-content: center; }
        .marker-background { width: 30px; height: 30px; border-radius: 50%; opacity: 0.9; display: flex; align-items: center; justify-content: center; background-color: #808080; }
        .custom-icon.glowing { box-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button { display: inline-block; margin: 0 5px; padding: 5px 10px; }
        .tab-button.active { background-color: #00ff00; color: #0a2a2a; }
        .small { font-size: 0.9em; color: #aaf0a0; }
        .marker-cluster div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 15px; font: bold 12px/30px "Helvetica Neue", Arial, Helvetica, sans-serif; background-color: #ffff00; color: #000000; }
        #xpStatus { text-align: center; margin-bottom: 20px; }
        progress { accent-color: #00ff00; width: 200px; }
        #categoryCheckboxes label { display: flex; align-items: center; margin: 5px 0; }
        #categoryCheckboxes input[type="checkbox"] { margin-right: 10px; }
        #buttonGroup { display: inline-block; }
        #tablePagination { text-align: center; margin: 10px 0; display: block; width: 100%; }
        #tablePagination button { margin: 0 5px; }
        .leaflet-popup-content { max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .leaflet-popup-content-wrapper { background-color: #1a3c34; color: #00ff00; font-family: 'Courier New', monospace; }
        .leaflet-popup-close-button { color: #00ff00 !important; font-size: 16px !important; }
        .leaflet-popup-close-button:hover { color: #0a2a2a !important; }
        .highlight-spacer { height: 2px; background: linear-gradient(to right, transparent, rgba(0, 255, 0, 0.3), transparent); }
        .spacer-row { height: 5px; background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent); }
        .grid-line { pointer-events: none; stroke: rgba(0, 255, 0, 0.35); stroke-width: 1; stroke-dasharray: 4, 4; }
        .grid-label { font-family: 'Courier New', monospace; font-size: 16px; font-weight: bold; fill: #00ff00; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; pointer-events: none; text-anchor: middle; dominant-baseline: central; }
        #gridNotification { position: fixed; bottom: 20px; right: 20px; background: #0a3a0a; color: #00ff00; padding: 14px 22px; border: 2px solid #00ff00; border-radius: 0; font-weight: bold; font-family: 'Courier New', monospace; font-size: 15px; box-shadow: 0 0 20px #00ff00, 0 0 40px rgba(0, 255, 0, 0.3); z-index: 10000; opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease, transform 0.3s ease; pointer-events: none; }
        #gridNotification.show { opacity: 1; transform: translateY(0); }
        #gridNotification::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(0, 255, 0, 0.1), transparent); pointer-events: none; border-radius: 0; }
        .confirm-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; background: rgba(0, 0, 0, 0.95); color: #00ff00; padding: 16px 24px; border: 3px solid #00ff00; border-radius: 0; font-family: 'Courier New', monospace; font-weight: bold; box-shadow: 0 0 20px #00ff00, 0 0 40px rgba(0, 255, 0, 0.5); text-align: center; max-width: 320px; }
        .confirm-popup .buttons { display: flex; justify-content: center; gap: 16px; margin-top: 12px; }
        .confirm-popup button { padding: 8px 16px; font-weight: bold; min-width: 70px; }
        .confirm-popup .ok { background: #00ff00; color: #000; }
        .confirm-popup .cancel { background: #444; color: #fff; }
        .flash-green { animation: flashGreen 0.6s ease-out; }
        @keyframes flashGreen { 0% { border-color: #00ff00; } 50% { border-color: #00ff88; box-shadow: 0 0 15px #00ff88; } 100% { border-color: #00ff00; } }
        @media (max-width: 768px) {
            #map { height: 600px; }
            .controls { flex-direction: column; align-items: center; }
            input[type="text"], select, button { width: 100%; max-width: 100%; margin: 5px 0; font-size: clamp(14px, 4vw, 16px); padding: clamp(10px, 2vw, 12px); }
            #combinedSearch { max-width: 100%; }
            .modal-content { max-width: 90%; padding: 12px; font-size: clamp(14px, 3.5vw, 16px); max-height: 80vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .close { font-size: clamp(20px, 5vw, 22px); }
            .grid-label { font-size: 12px; }
            #gridNotification { bottom: 10px; right: 10px; font-size: 13px; padding: 10px 16px; box-shadow: 0 0 15px #00ff00; }
            .confirm-popup { padding: 12px 16px; font-size: 14px; max-width: 90%; }
        }
    </style>
</head>
<body>
    <h1>The Fallout 76 Item Finder! Quickly log items while exploring Appalachia.</h1>
    <div id="map"></div>
    <div class="controls">
        <input type="text" id="combinedSearch" placeholder="description/category/grid..">
        <select id="categoryFilter"><option value="">All Categories</option></select>
        <button id="toggleCategoryModalBtn">Toggle Categories</button>
        <button id="toggleClusterBtn">Clustering: On</button>
        <button id="toggleMapBtn">Show No-Name Map</button>
        <button id="toggleGridBtn">Grid: Off</button>
        <button id="toggleButtonGroup">Hide Tools</button>
        <div id="buttonGroup">
            <button id="howToUseBtn">How to Use</button>
            <button id="nukeCodesBtn">Nuke Codes</button>
            <button id="toggleSoundsBtn">Sounds: On</button>
            <button id="exportJsonBtn">Export Markers</button>
            <button id="importBtn">Import Markers</button>
            <button id="downloadCommunityBtn">Download Community Map</button>
            <button id="saveMapJpegBtn">Save Map as JPEG</button>
        </div>
    </div>
    <div id="xpStatus">Explorer Level: <span id="levelSpan">1</span><br>XP: <progress id="xpProgress" value="0" max="1000"></progress> <span id="xpText">0 / 1000</span></div>
    <h2 style="text-align:center;">Content Inventory</h2>
    <p id="counter" style="text-align:center;"></p>
    <button id="toggleTableBtn" style="display: none;">Show Content Table</button>
    <div id="tableContainer">
        <div id="tablePagination">
            <button id="prevPageBtn" disabled>Prev</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPageBtn" disabled>Next</button>
        </div>
        <table id="locationsTable">
            <thead><tr><th>Icon</th><th>Category</th><th>Description</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="gridNotification"></div>

    <!-- ITEM MODAL -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <span class="close">X</span>
            <h2 id="modalTitle">Log Item</h2>
            <label>Category:</label>
            <select id="itemCategory"></select>
            <label>Description:</label>
            <textarea id="itemDesc" placeholder="Enter item and location details"></textarea>
            <div style="margin-top:12px;">
                <button id="saveItemBtn">Save</button>
                <button id="deleteItemBtn" style="background:#F7615E;color:#000;font-weight:700;display:none;">Delete</button>
                <button id="undoItemBtn" style="background:#cc8400;color:#000;font-weight:700;display:none;">Undo Delete</button>
                <button id="undoMoveBtn" style="background:#F7EA5E;color:#000;font-weight:700;display:none;">Undo Move</button>
                <button id="duplicateItemBtn" style="background:#5E99F7;color:#000;font-weight:700;display:none;">Duplicate</button>
            </div>
        </div>
    </div>

    <!-- INSTRUCTIONS + NUKE CODES MODAL -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <span class="close">X</span>
            <h1>Fallout 76 Item Finder Info</h1>
            <div>
                <button id="showInstructionsTab" class="tab-button active">How to Use</button>
                <button id="showNukeCodesTab" class="tab-button">Nuke Codes</button>
            </div>
            <div id="instructionsContent" class="tab-content active">
                <p><br>Double left-click (or double tap on mobile) the map to log an item. Newly logged/duplicated/edited locations will highlight for 2 minutes.</p>
                <p>Hold left-click (or drag on mobile) to move markers. Zoom in if markers are clustered to enable dragging. Confirm to save new position, cancel to revert, or use 'Undo Move' in the edit popup menu to revert accidental moves.</p>
                <p>Right-click or long-press (on mobile) on markers to edit, delete, or duplicate them (undo available after delete). Edit or delete from the Content Inventory.</p>
                <p>Left-click</strong> any row in the Content Table to page scrolls to map + zooms to marker!</p>
                <p>Right-click row opens Edit menu + zooms.</p>
                <p>Use the search bar to filter by description or category or grid number.</p>
                <p>Toggle between the named and no-name map versions using the "Toggle Map" button.</p>
                <p>Click anywhere on the map to see the grid coordinate (e.g., C4) in a green popup!</p>
                <p>Toggle the grid overlay with the "Grid" button.</p>
                <p>Create custom categories in the Toggle Categories menu to organize your items.</p>
                <p>Export User created or All logged locations to save data or import others' markers (duplicates are skipped).</p>
                <p>Save a JPEG of the map to capture your current view with markers.</p>
                <p>Gain XP for logging new items and level up like in Fallout 76! Lose XP for deleting items.</p>
                <p>For offline use on Android or iOS, save this locally and open in Chrome, Firefox, or Safari. An internet connection is needed for the map and libraries on first load.</p>
                <p>Check the "Download Community Map" button periodically for the latest map version or to reset the app if you encounter issues.</p>
                <button id="resetAppBtn" class="reset-btn">Reset App (for debugging only)</button>
                <p style="text-align:center;" class="small"><br>Love the Item Finder? Support MrCrazy with a <a href="https://buymeacoffee.com/mrcrazy" target="_blank" style="color:#00ff00;">Nuka-Cola</a>!</p>
                <p style="text-align:center;" class="small" id="appVersionText">The Fallout 76 Item Finder Map Version 30 Made By MrCrazy</p>
            </div>
            <div id="nukeCodesContent" class="tab-content">
                <p><strong><br>Nuke Codes</strong></p>
                <p class="small">Source: <a href="https://falloutbuilds.com/fo76/nuke-codes/" target="_blank" style="color:#00ff00;">falloutbuilds.com</a></p>
            </div>
        </div>
    </div>

    <!-- CATEGORY TOGGLE MODAL -->
    <div id="categoryToggleModal" class="modal">
        <div class="modal-content">
            <span class="close">X</span>
            <h2>Toggle Categories</h2>
            <div style="margin-bottom:10px;">
                <button id="selectAllBtn">Select All</button>
                <button id="deselectAllBtn">Deselect All</button>
                <button id="createCategoryBtn">Create Category</button>
                <button id="deleteCategoryBtn">Delete Category</button>
            </div>
            <div id="categoryCheckboxes"></div>
            <button id="closeCategoryToggleBtn">Close</button>
        </div>
    </div>

    <!-- CREATE CATEGORY MODAL -->
    <div id="createCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close">X</span>
            <h2>Create New Category</h2>
            <label>Category Name:</label>
            <input type="text" id="newCategoryName" placeholder="Enter category name">
            <label>Emoji (only one):</label>
            <input type="text" id="newCategoryEmoji" placeholder="Paste emoji" maxlength="2" inputmode="text">
            <p class="small">Paste one emoji. Only emojis allowed.</p>
            <div style="margin-top:12px;">
                <button id="saveCategoryBtn">Save Category</button>
            </div>
        </div>
    </div>

    <!-- DELETE CATEGORY MODAL -->
    <div id="deleteCategoryModal" class="modal">
        <div class="modal-content">
            <span class="close">X</span>
            <h2>Delete Category</h2>
            <label>Select Category to Delete:</label>
            <select id="deleteCategorySelect">
                <option value="">Select a custom category</option>
            </select>
            <p class="small">Deleting a category will reassign all its markers to "misc".</p>
            <div style="margin-top:12px;">
                <button id="confirmDeleteCategoryBtn">Delete Category</button>
            </div>
        </div>
    </div>

    <script>
(function() {
    const STORAGE_KEY = 'fallout76_locations';
    const CUSTOM_CATEGORIES_KEY = 'fallout76_custom_categories';
    const MAP_VERSION_KEY = 'fallout76_map_version';
    const TERMS_ACCEPTED_KEY = 'fallout76_terms_accepted';
    const APP_VERSION = "30";
    let soundsEnabled = localStorage.getItem('soundsEnabled') !== 'false';
    const baseSounds = {
        click: new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"),
        type: new Audio("https://actions.google.com/sounds/v1/doors/locked_doorknob_jiggle.ogg"),
        error: new Audio("https://actions.google.com/sounds/v1/impacts/dumpster_door_hit.ogg"),
        duplicate: new Audio("https://actions.google.com/sounds/v1/impacts/metal_thud.ogg"),
        saving: new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"),
        undo: new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg"),
        delete: new Audio("https://actions.google.com/sounds/v1/impacts/dumpster_door_hit.ogg"),
        levelUp: new Audio("https://actions.google.com/sounds/v1/cartoon/stomach_thumps.ogg"),
        modalClose: new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg")
    };
    Object.values(baseSounds).forEach(s => { s.volume = 0.15; });
    function playSound(type) {
        if (soundsEnabled && baseSounds[type]) {
            baseSounds[type].currentTime = 0;
            baseSounds[type].play().catch(() => {});
        }
    }
    function generateUniqueId() { return 'id-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now(); }

    let locations = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    locations.forEach(loc => { if (!loc.id) loc.id = generateUniqueId(); });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
    let customCategories = JSON.parse(localStorage.getItem(CUSTOM_CATEGORIES_KEY)) || {};
    let communityVersion = localStorage.getItem(MAP_VERSION_KEY) || "1.0";
    let termsAccepted = localStorage.getItem(TERMS_ACCEPTED_KEY) === 'true';

    // === REAL EMOJI ICONS NOT TEXT ===
    const defaultCategoryIcons = {
        'weapons': 'üî´', 'armor': 'üõ°Ô∏è', 'aid': 'üíâ', 'food/drink': 'üçΩÔ∏è', 'ammunition': 'üí•',
        'apparel': 'üëï', 'plans': 'üìú', 'junk': 'üóëÔ∏è', 'holotapes': 'üìÄ', 'misc': 'üìù',
        'plants': 'üåø', 'eggs': 'ü•ö', 'creatures': 'üê∫', 'vendors': 'üí∞', 'exchanges': '‚öñÔ∏è',
        'vaults': '‚öôÔ∏è', 'power armor': 'üë®‚ÄçüöÄ', 'fusion core': 'üîã', 'nuke drop zones': '‚ò¢Ô∏è',
        'nuke silos': 'üöÄ', 'magazines': 'üìö', 'bobbleheads': 'üéé', 'safe locations': 'üóÑÔ∏è',
        'terminal locations': 'üñ•Ô∏è', 'treasure maps': 'üó∫Ô∏è', 'resource deposits': '‚õèÔ∏è',
        'fishing locations': 'üé£', 'workshops': 'üîß', 'train stations': 'üöÇ', 'town locations': 'üè´',
        'event locations': 'üéâ', 'named locations': 'üö©', 'regions': 'üìç'
    };
    let categoryIcons = { ...defaultCategoryIcons, ...customCategories };
    const defaultCategoryColors = {
        'weapons': '#ff4444', 'armor': '#4682b4', 'aid': '#32cd32', 'food/drink': '#adff2f',
        'ammunition': '#ff8c00', 'apparel': '#dda0dd', 'plans': '#a0522d', 'junk': '#808080',
        'holotapes': '#f0e68c', 'misc': '#f0e68c', 'plants': '#228b22', 'eggs': '#f5f5dc',
        'creatures': '#8b0000', 'vendors': '#ffd700', 'exchanges': '#20b2aa', 'vaults': '#4682b4',
        'power armor': '#b22222', 'fusion core': '#ff4500', 'nuke drop zones': '#ff0000',
        'nuke silos': '#dc143c', 'magazines': '#ff69b4', 'bobbleheads': '#00b7eb',
        'treasure maps': '#d2b48c', 'resource deposits': '#696969', 'fishing locations': '#1e90ff',
        'workshops': '#b8860b', 'train stations': '#a9a9a9', 'town locations': '#228b22',
        'regions': '#00ff00', 'named locations': '#ffffff'
    };
    let categoryColors = { ...defaultCategoryColors };

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -3, maxZoom: 4, zoomControl: true, scrollWheelZoom: true, doubleClickZoom: true, boxZoom: true, touchZoom: true, dragging: true });
    const imageBounds = [[0, 0], [4096, 4096]];
    const mapUrls = {
        named: 'https://i.postimg.cc/HpqMVWjB/Mappalachia-Map-of-Appalachia.jpg',
        noName: 'https://i.postimg.cc/y6W7JMKB/Mappalachia-Map-of-Appalachia-no-name.jpg'
    };
    let currentMap = localStorage.getItem('currentMap') || 'named';
    let imageOverlay = L.imageOverlay(mapUrls[currentMap], imageBounds).addTo(map);
    map.fitBounds(imageBounds);

    const clusteredMarkers = L.markerClusterGroup({ maxClusterRadius: 30, disableClusteringAtZoom: 2 });
    const nonClusteredMarkers = L.layerGroup();
    map.addLayer(clusteredMarkers);
    map.addLayer(nonClusteredMarkers);

    let lastDeleted = null;
    let lastMovedMarker = null;
    let currentIndex = -1;
    let tempLatLng = { lat: 0, lng: 0 };
    let clusteringEnabled = localStorage.getItem('clusteringEnabled') !== 'false';
    let gridEnabled = localStorage.getItem('gridEnabled') === 'true';
    let activeCategories = new Set(
        localStorage.getItem('activeCategories')
            ? JSON.parse(localStorage.getItem('activeCategories'))
            : Object.keys(defaultCategoryIcons)
    );
    let level = parseInt(localStorage.getItem('fo76_level')) || 1;
    let xp = parseInt(localStorage.getItem('fo76_xp')) || 0;
    const xpPerLevel = 1000;
    const xpPerMarker = 100;
    const pageSize = 100;
    let tablePage = parseInt(localStorage.getItem('tablePage')) || 1;
    let tableVisible = localStorage.getItem('tableVisible') !== 'false';
    let currentSearch = localStorage.getItem('currentSearch') || '';
    let currentCategoryFilter = localStorage.getItem('currentCategoryFilter') || '';
    let isDuplicateEdit = false;

    // === GRID SYSTEM ===
    let gridLayer = L.layerGroup().addTo(map);
    function drawGrid() {
        gridLayer.clearLayers();
        if (!gridEnabled) return;
        const gridSize = 10;
        const cellSize = 4096 / gridSize;
        for (let i = 0; i <= gridSize; i++) {
            const x = i * cellSize;
            L.polyline([[0, x], [4096, x]], { className: 'grid-line', color: '#0f0', weight: 1, opacity: 0.5 }).addTo(gridLayer);
            const y = i * cellSize;
            L.polyline([[y, 0], [y, 4096]], { className: 'grid-line', color: '#0f0', weight: 1, opacity: 0.5 }).addTo(gridLayer);
        }
        const letters = 'ABCDEFGHIJ'.split('');
        for (let row = 0; row < gridSize; row++) {
            for (let col = 0; col < gridSize; col++) {
                const centerX = col * cellSize + cellSize / 2;
                const centerY = row * cellSize + cellSize / 2;
                const label = `${letters[col]}${row + 1}`;
                L.marker([centerY, centerX], {
                    icon: L.divIcon({ className: 'grid-label', html: label, iconSize: [30, 30], iconAnchor: [15, 15] })
                }).addTo(gridLayer);
            }
        }
    }

    function getGridFromLatLng(lat, lng) {
        const gridSize = 10;
        const cellSize = 4096 / gridSize;
        const col = Math.floor(lng / cellSize);
        const row = Math.floor(lat / cellSize);
        const letters = 'ABCDEFGHIJ';
        if (col >= 0 && col < letters.length && row >= 0 && row < gridSize) {
            return `${letters[col]}${row + 1}`;
        }
        return null;
    }

    function getLatLngFromGrid(grid) {
        const match = grid.toUpperCase().match(/^([A-J])(\d+)$/);
        if (!match) return null;
        const letters = 'ABCDEFGHIJ';
        const col = letters.indexOf(match[1]);
        const row = parseInt(match[2], 10) - 1;
        if (col === -1 || row < 0 || row >= 10) return null;
        const gridSize = 10;
        const cellSize = 4096 / gridSize;
        const centerX = col * cellSize + cellSize / 2;
        const centerY = row * cellSize + cellSize / 2;
        return { lat: centerY, lng: centerX };
    }

    function showGridNotification(grid) {
        const notif = document.getElementById('gridNotification');
        notif.textContent = `Grid: ${grid}`;
        notif.classList.add('show');
        setTimeout(() => notif.classList.remove('show'), 3000);
    }

    function highlightSearchBar(type = 'grid') {
        const search = document.getElementById('combinedSearch');
        search.classList.remove('grid-highlight', 'item-highlight');
        search.classList.add(type === 'grid' ? 'grid-highlight' : 'item-highlight');
        setTimeout(() => search.classList.remove(type === 'grid' ? 'grid-highlight' : 'item-highlight'), 1500);
    }

    function zoomToGrid(grid) {
        const coords = getLatLngFromGrid(grid);
        if (coords) {
            map.flyTo([coords.lat, coords.lng], 2);
            playSound('click');
        }
    }

    // === EMOJI VALIDATION ===
    function isValidEmoji(str) {
        if (!str || str.length === 0) return false;
        const emojiRegex = /^\p{Emoji}$/u;
        return emojiRegex.test(str.trim());
    }

    // === ELEMENTS ===
    const itemModal = document.getElementById('itemModal');
    const deleteBtn = document.getElementById('deleteItemBtn');
    const undoBtn = document.getElementById('undoItemBtn');
    const undoMoveBtn = document.getElementById('undoMoveBtn');
    const duplicateBtn = document.getElementById('duplicateItemBtn');
    const modalTitle = document.getElementById('modalTitle');
    const itemCategorySelect = document.getElementById('itemCategory');
    const itemDescInput = document.getElementById('itemDesc');
    const toggleSoundsBtn = document.getElementById('toggleSoundsBtn');
    const toggleClusterBtn = document.getElementById('toggleClusterBtn');
    const toggleMapBtn = document.getElementById('toggleMapBtn');
    const toggleGridBtn = document.getElementById('toggleGridBtn');
    const toggleButtonGroup = document.getElementById('toggleButtonGroup');
    const buttonGroup = document.getElementById('buttonGroup');
    const combinedSearch = document.getElementById('combinedSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const levelSpan = document.getElementById('levelSpan');
    const xpProgress = document.getElementById('xpProgress');
    const xpText = document.getElementById('xpText');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfo = document.getElementById('pageInfo');
    const tableContainer = document.getElementById('tableContainer');
    const toggleTableBtn = document.getElementById('toggleTableBtn');
    const counter = document.getElementById('counter');
    const categoryToggleModal = document.getElementById('categoryToggleModal');
    const toggleCategoryModalBtn = document.getElementById('toggleCategoryModalBtn');
    const howToUseBtn = document.getElementById('howToUseBtn');
    const nukeCodesBtn = document.getElementById('nukeCodesBtn');
    const exportBtn = document.getElementById('exportJsonBtn');
    const importBtn = document.getElementById('importBtn');
    const downloadCommunityBtn = document.getElementById('downloadCommunityBtn');
    const saveJpegBtn = document.getElementById('saveMapJpegBtn');
    const resetAppBtn = document.getElementById('resetAppBtn');
    const newCategoryEmoji = document.getElementById('newCategoryEmoji');

    toggleSoundsBtn.textContent = soundsEnabled ? 'Sounds: On' : 'Sounds: Off';
    toggleClusterBtn.textContent = `Clustering: ${clusteringEnabled ? 'On' : 'Off'}`;
    toggleMapBtn.textContent = currentMap === 'named' ? 'Show No-Name Map' : 'Show Named Map';
    toggleGridBtn.textContent = `Grid: ${gridEnabled ? 'On' : 'Off'}`;
    buttonGroup.style.display = 'none';
    toggleButtonGroup.textContent = 'Show Tools';
    combinedSearch.value = currentSearch;
    categoryFilter.value = currentCategoryFilter;

        // === TERMS AGREEMENT MODAL ===
    const termsModal = document.createElement('div');
    termsModal.className = 'modal';
    termsModal.style.display = 'block';
    termsModal.innerHTML = `
        <div class="modal-content">
            <h2>Welcome to Fallout 76 Item Finder v${APP_VERSION}</h2>
            <p>By using this app, you agree to:</p>
            <ul>
                <li>This app, created by MrCrazy, is for personal, non-commercial use by Fallout 76 players to track in-game items. Unauthorized copying, modification, distribution, or monetization is strictly prohibited. Do at your own risk.</li>
                <li>Stay Updated!</li>
                <li>Check the "Download Community Map" button periodically for the latest map version or to reset the app if you encounter issues. Find this tip in the "How to Use" section.</li>
            </ul>
            <p>Log and Track items in Appalachia with ease. Created by MrCrazy. Enjoy, and consider supporting with a <a href="https://buymeacoffee.com/mrcrazy" target="_blank" style="color:#00ff00;">Nuka-Cola ‚òï</a>!</p>
            <button id="acceptTermsBtn" style="background:#00ff00;color:#000;font-weight:700;">I Accept Terms</button>
        </div>
    `;

    // === DISABLE ALL BUTTONS UNTIL TERMS ACCEPTED ===
    const allButtons = document.querySelectorAll('button, input, select');
    function setButtonsEnabled(enabled) {
        allButtons.forEach(btn => {
            if (btn.id !== 'acceptTermsBtn') {
                btn.disabled = !enabled;
                btn.style.opacity = enabled ? '1' : '0.5';
                btn.style.pointerEvents = enabled ? 'auto' : 'none';
            }
        });
    }

    if (!termsAccepted) {
        document.body.appendChild(termsModal);
        document.body.classList.add('modal-open');
        setButtonsEnabled(false);

        document.getElementById('acceptTermsBtn').onclick = () => {
            localStorage.setItem(TERMS_ACCEPTED_KEY, 'true');
            termsModal.style.display = 'none';
            document.body.classList.remove('modal-open');
            setButtonsEnabled(true);
            playSound('click');
        };
    } else {
        setButtonsEnabled(true);
    }

    // === RESET APP BUTTON ===
    resetAppBtn.onclick = () => {
        if (confirm("WARNING: This will DELETE ALL markers, categories, and settings. Are you sure?")) {
            localStorage.clear();
            location.reload();
        }
    };

    // === EMOJI-ONLY INPUT + FLASH ON INVALID ===
    newCategoryEmoji.addEventListener('input', function(e) {
        const val = e.target.value;
        const clean = val.replace(/[^\p{Emoji}]/gu, '');
        if (val !== clean) e.target.value = clean;
    });

    // === CREATE CATEGORY WITH FLASH VALIDATION ===
    document.getElementById('saveCategoryBtn').onclick = () => {
        const nameInput = document.getElementById('newCategoryName');
        const emojiInput = document.getElementById('newCategoryEmoji');
        const name = nameInput.value.trim();
        const emoji = emojiInput.value.trim();

        if (!name || categoryIcons[name]) {
            nameInput.classList.add('flash-green');
            setTimeout(() => nameInput.classList.remove('flash-green'), 600);
            return;
        }

        if (!isValidEmoji(emoji)) {
            emojiInput.classList.add('flash-green');
            setTimeout(() => emojiInput.classList.remove('flash-green'), 600);
            return;
        }

        customCategories[name] = emoji;
        categoryIcons[name] = emoji;
        categoryColors[name] = '#f0e68c';
        activeCategories.add(name);
        localStorage.setItem(CUSTOM_CATEGORIES_KEY, JSON.stringify(customCategories));
        localStorage.setItem('activeCategories', JSON.stringify([...activeCategories]));
        document.getElementById('createCategoryModal').style.display = 'none';
        renderCategoryToggles();
        updateCategoryDropdowns();
        loadData();
        playSound('saving');
    };

    function refreshTableVisibility() {
        const isMobile = window.innerWidth <= 768;
        toggleTableBtn.style.display = isMobile ? 'block' : 'none';
        if (isMobile) {
            tableContainer.style.display = tableVisible ? 'block' : 'none';
            toggleTableBtn.textContent = tableVisible ? 'Hide Content Table' : 'Show Content Table';
        }
    }

    function renderCategoryToggles() {
        const container = document.getElementById('categoryCheckboxes');
        if (!container) return;
        container.innerHTML = '';
        const allCats = [...Object.keys(defaultCategoryIcons), ...Object.keys(customCategories)].sort();
        allCats.forEach(cat => {
            const label = document.createElement('label');
            const checked = activeCategories.has(cat) ? 'checked' : '';
            label.innerHTML = `<input type="checkbox" value="${cat}" ${checked}><span>${cat} ${categoryIcons[cat] || ''}</span>`;
            container.appendChild(label);
        });
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', () => {
                const val = cb.value;
                if (cb.checked) activeCategories.add(val);
                else activeCategories.delete(val);
                localStorage.setItem('activeCategories', JSON.stringify([...activeCategories]));
                loadData(combinedSearch.value, categoryFilter.value);
            });
        });
    }

    function updateCategoryDropdowns() {
        const categories = [...Object.keys(defaultCategoryIcons), ...Object.keys(customCategories)].sort();
        const makeOption = cat => `<option value="${cat}">${cat} ${categoryIcons[cat] || ''}</option>`;
        categoryFilter.innerHTML = '<option value="">All Categories</option>' + categories.map(makeOption).join('');
        itemCategorySelect.innerHTML = categories.map(makeOption).join('');
        if (currentCategoryFilter && categories.includes(currentCategoryFilter)) {
            categoryFilter.value = currentCategoryFilter;
        }
    }

    function isGlowing(loc) {
        return loc.addedTime && (Date.now() - loc.addedTime) < 120000;
    }

    function createMarkerIcon(loc) {
        const isTextOnly = ['named locations', 'regions'].includes(loc.category);
        if (isTextOnly) {
            const words = loc.desc.split('\n')[0].trim().split(' ');
            const shortText = words.slice(0, 3).join(' ') + (words.length > 3 ? '...' : '');
            const width = Math.min(120, Math.max(60, shortText.length * 9));
            return L.divIcon({
                className: 'text-marker',
                html: `<div style="background:#000; color:#fff; padding:3px 6px; border:2px solid #0f0; border-radius:4px; font-weight:bold; font-size:11px; white-space:nowrap; width:${width}px; text-align:center; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(shortText)}</div>`,
                iconSize: [width + 12, 26],
                iconAnchor: [(width + 12)/2, 13]
            });
        } else {
            const base = `<div class="marker-background" style="background-color:${categoryColors[loc.category] || '#808080'};">
                            <span style="font-size:18px;">${loc.icon}</span>
                          </div>`;
            return L.divIcon({
                className: isGlowing(loc) ? 'custom-icon glowing' : 'custom-icon',
                html: base,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
        }
    }

    // === TEMP MESSAGE QUEUE - PREVENTS OVERLAP & DRAG INTERFERENCE ===
    const messageQueue = [];
    let activeMessageControl = null;
    function showTempMessage(html, ms = 3000) {
        messageQueue.push({ html, ms });
        if (!activeMessageControl) processMessageQueue();
    }

    function processMessageQueue() {
        if (messageQueue.length === 0 || activeMessageControl) return;
        const { html, ms } = messageQueue.shift();

        activeMessageControl = L.control({ position: 'bottomright' });
        activeMessageControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'temp-message');
            div.innerHTML = html;
            div.style.cssText = 'background:rgba(0,0,0,0.85); color:#0f0; padding:8px 12px; border:1px solid #0f0; border-radius:6px; max-width:300px; font:bold 13px/1.4 monospace; box-shadow:0 0 10px #0f0; margin:10px; pointer-events:none; z-index:10000;';
            L.DomEvent.disableClickPropagation(div);
            return div;
        };
        activeMessageControl.addTo(map);

        setTimeout(() => {
            if (activeMessageControl) {
                map.removeControl(activeMessageControl);
                activeMessageControl = null;
                processMessageQueue();
            }
        }, ms);
    }

    // === UNIFIED DRAG HANDLER - SUPPORTS PC & MOBILE EMOJI ICONS ===
function attachDragHandler(marker, loc) {
    let originalLatLng = null;
    let isDragging = false;

    // A single, unified function for handling drag movement
    const onDragging = (e) => {
        if (!isDragging) return;
        
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        const latlng = map.mouseEventToLatLng({ clientX: clientX, clientY: clientY });
        marker.setLatLng(latlng);
    };

    // A single, unified function for handling the end of a drag
    const onDragEnd = () => {
        if (!isDragging) return;
        isDragging = false;
        map.dragging.enable();
        L.DomUtil.removeClass(marker._icon, 'dragging');

        // Clean up both mouse and touch listeners from the document
        L.DomEvent.off(document, 'mousemove', onDragging);
        L.DomEvent.off(document, 'mouseup', onDragEnd);
        L.DomEvent.off(document, 'touchmove', onDragging);
        L.DomEvent.off(document, 'touchend', onDragEnd);

        const newLatLng = marker.getLatLng();
        showConfirmPopup('Save new position?', () => {
            loc.lat = newLatLng.lat;
            loc.lng = newLatLng.lng;
            loc.addedTime = Date.now();
            loc.userEdited = true;
            lastMovedMarker = { marker, original: originalLatLng, index: locations.indexOf(loc) };
            undoMoveBtn.style.display = 'inline-block';
            saveLocations();
            playSound('saving');
            showTempMessage(`Moved: ${loc.icon} ${loc.category}`, 5000);
            map.flyTo([newLatLng.lat, newLatLng.lng], 2);
            forceReload();
        }, () => {
            marker.setLatLng(originalLatLng);
            map.flyTo([originalLatLng.lat, originalLatLng.lng], 2);
        });
    };

    // Use a unified drag start handler for both mouse and touch
    const onDragStart = (e) => {
        // Prevent default browser behavior (like scrolling) for touch events
        // This is critical for preventing scroll on mobile devices
        if (e.touches) {
            L.DomEvent.preventDefault(e);
        }

        originalLatLng = marker.getLatLng();
        isDragging = true;
        map.dragging.disable();
        L.DomUtil.addClass(marker._icon, 'dragging');

        if (activeMessageControl) {
            map.removeControl(activeMessageControl);
            activeMessageControl = null;
        }
        
        // Attach touch and mouse move/end listeners to the document
        L.DomEvent.on(document, 'mousemove', onDragging);
        L.DomEvent.on(document, 'mouseup', onDragEnd);
        L.DomEvent.on(document, 'touchmove', onDragging);
        L.DomEvent.on(document, 'touchend', onDragEnd);
    };
    
    // Listen for Leaflet's 'dragstart' event, which is triggered by both mouse and touch
    marker.on('dragstart', onDragStart);

        marker.on('contextmenu', e => {
            L.DomEvent.stopPropagation(e);
            openModal('Edit Item', locations.findIndex(l => l.id === loc.id));
        });
        marker.bindPopup(`<b>${loc.icon} ${loc.category.toUpperCase()}</b><br>${escapeHtml(loc.desc)}`, { maxWidth: 300 });
    }

    function addMarkerToMap(loc) {
        const marker = L.marker([loc.lat, loc.lng], {
            icon: createMarkerIcon(loc),
            id: loc.id,
            draggable: true
        });

        attachDragHandler(marker, loc);

        const isTextOnly = ['named locations', 'regions'].includes(loc.category);
        if (clusteringEnabled && !isTextOnly) {
            clusteredMarkers.addLayer(marker);
        } else {
            nonClusteredMarkers.addLayer(marker);
        }
    }

    function refreshTable(search = '', catFilter = '') {
        const tbody = document.querySelector('#locationsTable tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const filtered = locations.filter(loc => {
            if (!activeCategories.has(loc.category)) return false;
            if (catFilter && loc.category !== catFilter) return false;
            if (!search) return true;
            return normalizeString(loc.desc).includes(normalizeString(search)) ||
                   normalizeString(loc.category).includes(normalizeString(search));
        });

        const glowing = filtered.filter(isGlowing).sort((a, b) => b.addedTime - a.addedTime);
        const normal = filtered.filter(loc => !isGlowing(loc)).sort((a, b) => {
            const catDiff = a.category.localeCompare(b.category);
            return catDiff !== 0 ? catDiff : a.desc.localeCompare(b.desc);
        });
        const sorted = [...glowing, ...normal];

        const start = (tablePage - 1) * pageSize;
        const pageItems = sorted.slice(start, start + pageSize);
        pageItems.forEach(loc => {
            const tr = document.createElement('tr');
            if (isGlowing(loc)) tr.classList.add('glowing');
            const shortDesc = loc.desc.split('\n')[0].trim();
            const iconCell = ['named locations', 'regions'].includes(loc.category)
                ? `<div style="background:#000; color:#fff; padding:2px 6px; border:1px solid #0f0; border-radius:3px; font-weight:bold; font-size:11px; display:inline-block; max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(shortDesc)}</div>`
                : `<div style="background-color:${categoryColors[loc.category] || '#808080'}; width:30px; height:30px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:#000; font-weight:bold; font-size:16px;">${loc.icon}</div>`;
            tr.innerHTML = `
                <td>${iconCell}</td>
                <td>${escapeHtml(loc.category)} ${loc.icon}</td>
                <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(shortDesc)}</td>
            `;

            tr.onclick = (e) => {
                e.preventDefault();
                const mapEl = document.getElementById('map');
                mapEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => {
                    map.flyTo([loc.lat, loc.lng], 2);
                    playSound('click');
                }, 300);
            };

            tr.oncontextmenu = (e) => {
                e.preventDefault();
                const mapEl = document.getElementById('map');
                mapEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => {
                    map.flyTo([loc.lat, loc.lng], 2);
                    openModal('Edit Item', locations.findIndex(l => l.id === loc.id));
                }, 300);
            };

            tbody.appendChild(tr);
        });

        const totalPages = Math.ceil(sorted.length / pageSize);
        tablePage = Math.min(tablePage, totalPages || 1);
        pageInfo.textContent = `Page ${tablePage} of ${totalPages || 1}`;
        prevPageBtn.disabled = tablePage <= 1;
        nextPageBtn.disabled = tablePage >= totalPages;
        counter.innerHTML = `<strong>Map Version ${communityVersion}</strong> - <strong>${sorted.length}</strong> logged locations - <strong>${pageItems.length}</strong> showing.`;
    }

    setInterval(() => {
        if (document.visibilityState === 'visible') {
            [clusteredMarkers, nonClusteredMarkers].forEach(group => {
                group.eachLayer(marker => {
                    const loc = locations.find(l => l.id === marker.options.id);
                    if (loc) {
                        const shouldGlow = isGlowing(loc);
                        const currentIcon = marker.getIcon();
                        if (shouldGlow && !currentIcon.options.className.includes('glowing')) {
                            marker.setIcon(createMarkerIcon(loc));
                        } else if (!shouldGlow && currentIcon.options.className.includes('glowing')) {
                            marker.setIcon(createMarkerIcon(loc));
                        }
                    }
                });
            });
            refreshTable(combinedSearch.value, categoryFilter.value);
        }
    }, 1000);

    function showConfirmPopup(message, onConfirm, onCancel) {
        const popup = document.createElement('div');
        popup.className = 'confirm-popup';
        popup.innerHTML = `
            <b>${escapeHtml(message)}</b>
            <div class="buttons">
                <button class="ok">OK</button>
                <button class="cancel">CANCEL</button>
            </div>
        `;
        document.body.appendChild(popup);

        popup.querySelector('.ok').onclick = () => {
            document.body.removeChild(popup);
            onConfirm();
            playSound('click');
        };
        popup.querySelector('.cancel').onclick = () => {
            document.body.removeChild(popup);
            if (onCancel) onCancel();
            playSound('error');
        };
    }

    function openModal(title, index = -1, isDupe = false) {
        modalTitle.textContent = title;
        currentIndex = index;
        isDuplicateEdit = isDupe;

        document.getElementById('saveItemBtn').style.display = 'inline-block';

        if (index >= 0 && !isDupe) {
            const loc = locations[index];
            itemCategorySelect.value = loc.category || 'misc';
            itemDescInput.value = loc.desc || '';
            deleteBtn.style.display = 'inline-block';
            duplicateBtn.style.display = 'inline-block';
            undoBtn.style.display = lastDeleted ? 'inline-block' : 'none';
            undoMoveBtn.style.display = (lastMovedMarker && lastMovedMarker.index === index) ? 'inline-block' : 'none';
        } else {
            itemCategorySelect.value = 'misc';
            itemDescInput.value = '';
            deleteBtn.style.display = 'none';
            duplicateBtn.style.display = 'none';
            undoBtn.style.display = 'none';
            undoMoveBtn.style.display = 'none';
        }
        itemModal.style.display = 'block';
        document.body.classList.add('modal-open');
        playSound('click');
    }

    function closeModal(modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
        playSound('modalClose');
    }

    document.querySelectorAll('.modal .close').forEach(closeBtn => {
        closeBtn.onclick = () => closeModal(closeBtn.closest('.modal'));
    });

    window.onclick = e => {
        if (e.target.classList.contains('modal')) {
            closeModal(e.target);
        }
    };

    function recalculateXP() {
        xp = locations.length * xpPerMarker;
        level = 1 + Math.floor(xp / xpPerLevel);
        xp = xp % xpPerLevel;
        if (xp < 0) xp = 0;
        localStorage.setItem('fo76_level', level);
        localStorage.setItem('fo76_xp', xp);
    }
    recalculateXP();

    function updateXPBar() {
        levelSpan.textContent = level;
        xpProgress.value = xp;
        xpProgress.max = xpPerLevel;
        xpText.textContent = `${xp} / ${xpPerLevel}`;
    }

    function loadData(search = '', catFilter = '') {
        clusteredMarkers.clearLayers();
        nonClusteredMarkers.clearLayers();
        const filtered = locations.filter(loc => activeCategories.has(loc.category) && (!catFilter || loc.category === catFilter) && (!search || normalizeString(loc.desc + loc.category).includes(normalizeString(search))));
        filtered.forEach(addMarkerToMap);
        refreshTable(search, catFilter);
        updateXPBar();
        drawGrid();
        saveAppState();
    }

    function forceReload() {
        saveAppState();
        loadData(combinedSearch.value, categoryFilter.value);
        renderCategoryToggles();
        updateCategoryDropdowns();
        refreshTableVisibility();
    }

    function saveAppState() {
        localStorage.setItem('currentSearch', combinedSearch.value);
        localStorage.setItem('currentCategoryFilter', categoryFilter.value);
        localStorage.setItem('tablePage', tablePage);
        localStorage.setItem('tableVisible', tableVisible);
        localStorage.setItem('clusteringEnabled', clusteringEnabled);
        localStorage.setItem('gridEnabled', gridEnabled);
        localStorage.setItem('currentMap', currentMap);
        localStorage.setItem(MAP_VERSION_KEY, communityVersion);
    }

    function saveLocations() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
        saveAppState();
    }

    function normalizeString(s) { return (s || '').toString().trim().toLowerCase(); }
    function escapeHtml(unsafe) { return (unsafe || '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }

    // === BUTTONS & EVENTS ===
    howToUseBtn.onclick = () => { document.getElementById('instructionsModal').style.display = 'block'; document.getElementById('showInstructionsTab').click(); playSound('click'); };
    nukeCodesBtn.onclick = () => { document.getElementById('instructionsModal').style.display = 'block'; document.getElementById('showNukeCodesTab').click(); playSound('click'); };

    document.getElementById('showInstructionsTab').onclick = () => {
        document.getElementById('instructionsContent').classList.add('active');
        document.getElementById('nukeCodesContent').classList.remove('active');
        document.getElementById('showInstructionsTab').classList.add('active');
        document.getElementById('showNukeCodesTab').classList.remove('active');
        playSound('click');
    };
    document.getElementById('showNukeCodesTab').onclick = () => {
        document.getElementById('nukeCodesContent').classList.add('active');
        document.getElementById('instructionsContent').classList.remove('active');
        document.getElementById('showNukeCodesTab').classList.add('active');
        document.getElementById('showInstructionsTab').classList.remove('active');
        playSound('click');
    };

    exportBtn.onclick = () => {
        playSound('saving');
        const wantsAll = confirm(
            'Click **OK** to export **ALL** locations + custom categories.\n\n' +
            'Click **Cancel** to export **USER-LOGGED** locations only (excludes any community marker you never edited).'
        );
        const exportData = {
            version: 1.0,
            communityVersion: communityVersion,
            customCategories: customCategories
        };
        if (wantsAll) {
            exportData.locations = locations;
            exportData.note = 'ALL logged locations (community + user)';
        } else {
            exportData.locations = locations.filter(loc => loc.userEdited === true);
            exportData.note = 'USER-ONLY locations (your edits only)';
        }
        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const typeSuffix = wantsAll ? 'all' : 'user';
        link.download = `fallout76_${typeSuffix}_${exportData.locations.length}_locations_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        link.click();
        URL.revokeObjectURL(url);
        alert(wantsAll ? 'Exported **ALL** logged locations!' : 'Exported **USER-ONLY** locations!');
    };

    importBtn.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    const imported = data.locations || [];
                    const newLocations = [];
                    let skippedUserEdited = 0;
                    let skippedDuplicateIds = 0;
                    let skippedDuplicateCoords = 0;
                    let skippedUnchanged = 0;
                    let skippedCount = 0;
                    let customCategoriesUpdated = false;

                    imported.forEach(loc => {
                        loc.id = generateUniqueId();
                        loc.addedTime = Date.now();

                        if (!data.note || !data.note.includes('USER-ONLY')) {
                            loc.userEdited = false;
                        } else {
                            loc.userEdited = true;
                        }

                        const existingById = locations.find(l => l.id === loc.id);
                        const existingByCoords = locations.find(l => 
                            Math.abs(l.lat - loc.lat) < 1 && Math.abs(l.lng - loc.lng) < 1
                        );

                        if (existingByCoords && existingByCoords.userEdited) {
                            skippedCount++;
                            skippedUserEdited++;
                            return;
                        }

                        if (existingById || existingByCoords) {
                            skippedCount++;
                            if (existingById) skippedDuplicateIds++;
                            if (existingByCoords) skippedDuplicateCoords++;
                            if (existingById && JSON.stringify(loc) === JSON.stringify(existingById)) skippedUnchanged++;
                            return;
                        }

                        newLocations.push(loc);
                    });

                    locations = [...locations, ...newLocations];
                    recalculateXP();

                    if (data.customCategories && typeof data.customCategories === 'object') {
                        Object.entries(data.customCategories).forEach(([name, emoji]) => {
                            if (!customCategories[name] && !defaultCategoryIcons[name] && isValidEmoji(emoji) && !Object.values(categoryIcons).includes(emoji)) {
                                customCategories[name] = emoji;
                                categoryIcons[name] = emoji;
                                categoryColors[name] = '#f0e68c';
                                activeCategories.add(name);
                                customCategoriesUpdated = true;
                            }
                        });
                    }
                    communityVersion = data.communityVersion || "0.0";
                    localStorage.setItem(MAP_VERSION_KEY, communityVersion);
                    saveLocations();
                    localStorage.setItem(CUSTOM_CATEGORIES_KEY, JSON.stringify(customCategories));
                    localStorage.setItem('activeCategories', JSON.stringify(Array.from(activeCategories)));
                    forceReload();
                    let message = `Imported ${newLocations.length} new locations successfully!`;
                    if (skippedUserEdited > 0) message += `\nSkipped ${skippedUserEdited} user-edited locations. Delete these markers and re-import to update them.`;
                    if (skippedCount > 0) message += `\nSkipped ${skippedCount} locations (${skippedDuplicateIds} duplicate IDs, ${skippedDuplicateCoords} duplicate coordinates, ${skippedUnchanged} unchanged).`;
                    if (customCategoriesUpdated) message += `\nUpdated custom categories.`;
                    message += `\nTotal of ${locations.length} locations logged.`;
                    alert(message);
                    playSound('saving');
                } catch (err) {
                    console.error('Import error:', err);
                    alert(`Error importing file: ${err.message || 'Invalid JSON format.'}`);
                    playSound('error');
                }
                e.target.value = '';
            };
            reader.readAsText(file);
        };
        input.click();
    };

    downloadCommunityBtn.onclick = () => {
        playSound('click');
        const filename = `fallout76_community_map_v${communityVersion}.json`;
        window.open(`https://www.dropbox.com/scl/fi/uc525iq6f6lqkm3zaftvo/${filename}?rlkey=jtnqtek3x2kjimkvb4jed2pcj&st=pavd5wzd&dl=1`, '_blank');
    };

    saveJpegBtn.onclick = () => {
        playSound('saving');
        html2canvas(document.getElementById('map'), { useCORS: true, scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `fallout76_map_${new Date().toISOString().replace(/[:.]/g, '-')}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            alert('Map saved as JPEG. Check your downloads folder!');
        }).catch(err => {
            console.error(err);
            alert('Failed to save map as JPEG.');
            playSound('error');
        });
    };

    prevPageBtn.onclick = () => { if (tablePage > 1) { tablePage--; localStorage.setItem('tablePage', tablePage); refreshTable(combinedSearch.value, categoryFilter.value); playSound('click'); } };
    nextPageBtn.onclick = () => { const total = Math.ceil(locations.filter(l => activeCategories.has(l.category)).length / pageSize); if (tablePage < total) { tablePage++; localStorage.setItem('tablePage', tablePage); refreshTable(combinedSearch.value, categoryFilter.value); playSound('click'); } };
    toggleTableBtn.onclick = () => { tableVisible = !tableVisible; localStorage.setItem('tableVisible', tableVisible); refreshTableVisibility(); playSound('click'); };
    toggleSoundsBtn.onclick = () => { soundsEnabled = !soundsEnabled; localStorage.setItem('soundsEnabled', soundsEnabled); toggleSoundsBtn.textContent = soundsEnabled ? 'Sounds: On' : 'Sounds: Off'; playSound('click'); };
    toggleClusterBtn.onclick = () => { clusteringEnabled = !clusteringEnabled; localStorage.setItem('clusteringEnabled', clusteringEnabled); toggleClusterBtn.textContent = `Clustering: ${clusteringEnabled ? 'On' : 'Off'}`; playSound('click'); loadData(combinedSearch.value, categoryFilter.value); };
    toggleMapBtn.onclick = () => { currentMap = currentMap === 'named' ? 'noName' : 'named'; localStorage.setItem('currentMap', currentMap); toggleMapBtn.textContent = currentMap === 'named' ? 'Show No-Name Map' : 'Show Named Map'; map.removeLayer(imageOverlay); imageOverlay = L.imageOverlay(mapUrls[currentMap], imageBounds).addTo(map); playSound('saving'); };
    toggleGridBtn.onclick = () => { gridEnabled = !gridEnabled; localStorage.setItem('gridEnabled', gridEnabled); toggleGridBtn.textContent = `Grid: ${gridEnabled ? 'On' : 'Off'}`; drawGrid(); playSound('click'); };
    toggleButtonGroup.onclick = () => { const willShow = buttonGroup.style.display === 'none'; buttonGroup.style.display = willShow ? 'block' : 'none'; toggleButtonGroup.textContent = willShow ? 'Hide Tools' : 'Show Tools'; playSound('click'); };
    toggleCategoryModalBtn.onclick = () => { categoryToggleModal.style.display = 'block'; document.body.classList.add('modal-open'); renderCategoryToggles(); playSound('click'); };

    categoryFilter.addEventListener('change', () => { playSound('click'); loadData(combinedSearch.value, categoryFilter.value); });
    combinedSearch.addEventListener('input', () => {
        const val = combinedSearch.value.trim();
        let hasGrid = false;
        let hasItem = false;

        if (val.length === 2 || val.length === 3) {
            const gridMatch = val.toUpperCase().match(/^([A-J])(\d+)$/);
            if (gridMatch) {
                hasGrid = true;
                zoomToGrid(val);
            }
        }

        if (val.length >= 2) {
            const lowerVal = val.toLowerCase();
            hasItem = locations.some(loc => 
                activeCategories.has(loc.category) &&
                (normalizeString(loc.desc).includes(lowerVal) || normalizeString(loc.category).includes(lowerVal))
            );
        }

        if (hasGrid) {
            highlightSearchBar('grid');
        } else if (hasItem) {
            highlightSearchBar('item');
        }

        loadData(val, categoryFilter.value);
    });

    map.on('click', e => {
        const grid = getGridFromLatLng(e.latlng.lat, e.latlng.lng);
        if (grid) {
            showGridNotification(grid);
            playSound('click');
        }
    });

    map.on('dblclick', e => {
    // If user hasn‚Äôt accepted terms yet, show the agreement popup instead
    if (!localStorage.getItem(TERMS_ACCEPTED_KEY) || localStorage.getItem(TERMS_ACCEPTED_KEY) !== 'true') {
        // Prevent map from logging items
        L.DomEvent.stopPropagation(e);

        // If the terms modal isn‚Äôt already showing, show it
        if (!document.body.contains(termsModal)) {
            document.body.appendChild(termsModal);
        }
        termsModal.style.display = 'block';
        document.body.classList.add('modal-open');
        setButtonsEnabled(false);
        playSound('error');
        return; // stop here until user agrees
    }

    // Otherwise proceed normally
    tempLatLng = e.latlng;
    const grid = getGridFromLatLng(tempLatLng.lat, tempLatLng.lng);
    const x = Math.round(tempLatLng.lng);
    const y = Math.round(tempLatLng.lat);
    const defaultDesc = grid ? `Grid ${grid} (X: ${x}, Y: ${y})` : `X: ${x}, Y: ${y}`;
    itemDescInput.value = defaultDesc;
    openModal('Log Item', -1);
    L.DomEvent.stopPropagation(e);
});

    document.getElementById('saveItemBtn').onclick = () => {
        const category = itemCategorySelect.value;
        let desc = itemDescInput.value.trim();

        if (!desc) {
            const lat = currentIndex >= 0 ? locations[currentIndex].lat : tempLatLng.lat;
            const lng = currentIndex >= 0 ? locations[currentIndex].lng : tempLatLng.lng;
            const grid = getGridFromLatLng(lat, lng);
            const x = Math.round(lng);
            const y = Math.round(lat);
            desc = grid ? `Grid ${grid} (X: ${x}, Y: ${y})` : `X: ${x}, Y: ${y}`;
            itemDescInput.value = desc;
        }

        if (!desc) return;

        if (currentIndex >= 0) {
            const loc = locations[currentIndex];
            loc.category = category;
            loc.desc = desc;
            loc.icon = categoryIcons[category] || 'UNKNOWN';
            loc.addedTime = Date.now();
            loc.userEdited = true;
        } else {
            const newLoc = { 
                id: generateUniqueId(), 
                lat: tempLatLng.lat, 
                lng: tempLatLng.lng, 
                category, 
                desc, 
                icon: categoryIcons[category] || 'UNKNOWN', 
                addedTime: Date.now(),
                userEdited: true
            };
            locations.push(newLoc);
            recalculateXP();
        }
        closeModal(itemModal);
        saveLocations();
        playSound('saving');
        showTempMessage('Saved!', 2000);
        const finalLoc = currentIndex >= 0 ? locations[currentIndex] : locations[locations.length - 1];
        map.flyTo([finalLoc.lat, finalLoc.lng], 2);
        forceReload();
    };

    deleteBtn.onclick = () => {
        if (currentIndex >= 0) {
            const loc = locations[currentIndex];
            lastDeleted = { ...loc };
            locations.splice(currentIndex, 1);
            recalculateXP();
            closeModal(itemModal);
            map.flyTo([loc.lat, loc.lng], map.getZoom() + 1);
            saveLocations();
            forceReload();
            undoBtn.style.display = 'inline-block';
            showTempMessage('Deleted! Use Undo to restore.', 4000);
            playSound('delete');
        }
    };

    undoBtn.onclick = () => {
        if (lastDeleted) {
            locations.push(lastDeleted);
            lastDeleted = null;
            recalculateXP();
            saveLocations();
            forceReload();
            undoBtn.style.display = 'none';
            closeModal(itemModal);
            map.flyTo([locations[locations.length-1].lat, locations[locations.length-1].lng], map.getZoom() + 1);
            showTempMessage('Undo successful!', 3000);
            playSound('undo');
        }
    };

    undoMoveBtn.onclick = () => {
        if (lastMovedMarker && lastMovedMarker.index >= 0) {
            const loc = locations[lastMovedMarker.index];
            loc.lat = lastMovedMarker.original.lat;
            loc.lng = lastMovedMarker.original.lng;
            lastMovedMarker = null;
            undoMoveBtn.style.display = 'none';
            saveLocations();
            forceReload();
            closeModal(itemModal);
            map.flyTo([loc.lat, loc.lng], map.getZoom() + 1);
            showTempMessage('Move undone!', 3000);
            playSound('undo');
        }
    };

    duplicateBtn.onclick = () => {
        if (currentIndex >= 0) {
            const loc = locations[currentIndex];
            const offset = 30 / Math.pow(2, map.getZoom());
            const newLoc = {
                ...loc,
                id: generateUniqueId(),
                lat: loc.lat + offset,
                lng: loc.lng + offset,
                addedTime: Date.now(),
                userEdited: true
            };
            locations.push(newLoc);
            recalculateXP();
            saveLocations();
            forceReload();
            closeModal(itemModal);
            const newIndex = locations.findIndex(l => l.id === newLoc.id);
            map.flyTo([newLoc.lat, newLoc.lng], map.getZoom());
            showTempMessage('Duplicated! Edit below.', 3000);
            playSound('duplicate');
        }
    };

    document.getElementById('selectAllBtn').onclick = () => {
        document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
        activeCategories = new Set(Object.keys(categoryIcons));
        localStorage.setItem('activeCategories', JSON.stringify([...activeCategories]));
        loadData();
    };
    document.getElementById('deselectAllBtn').onclick = () => {
        document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
        activeCategories = new Set();
        localStorage.setItem('activeCategories', JSON.stringify([]));
        loadData();
    };
    document.getElementById('createCategoryBtn').onclick = () => {
        document.getElementById('createCategoryModal').style.display = 'block';
    };
    document.getElementById('deleteCategoryBtn').onclick = () => {
        const select = document.getElementById('deleteCategorySelect');
        select.innerHTML = '<option value="">Select...</option>';
        Object.keys(customCategories).forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            select.appendChild(opt);
        });
        document.getElementById('deleteCategoryModal').style.display = 'block';
    };
    document.getElementById('confirmDeleteCategoryBtn').onclick = () => {
        const name = document.getElementById('deleteCategorySelect').value;
        if (name && customCategories[name]) {
            delete customCategories[name];
            delete categoryIcons[name];
            locations.forEach(l => { if (l.category === name) l.category = 'misc'; });
            activeCategories.delete(name);
            localStorage.setItem(CUSTOM_CATEGORIES_KEY, JSON.stringify(customCategories));
            localStorage.setItem('activeCategories', JSON.stringify([...activeCategories]));
            document.getElementById('deleteCategoryModal').style.display = 'none';
            renderCategoryToggles();
            updateCategoryDropdowns();
            loadData();
            playSound('delete');
        }
    };

    document.querySelectorAll('#createCategoryModal .close, #deleteCategoryModal .close, #categoryToggleModal .close, #closeCategoryToggleBtn').forEach(btn => {
        btn.onclick = () => {
            btn.closest('.modal').style.display = 'none';
            document.body.classList.remove('modal-open');
            playSound('modalClose');
        };
    });

    renderCategoryToggles();
    updateCategoryDropdowns();
    loadData();
    refreshTableVisibility();
    window.addEventListener('resize', refreshTableVisibility);

    setInterval(() => {
        fetch('https://falloutbuilds.com/fo76/nuke-codes/')
            .then(r => r.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const codes = doc.querySelectorAll('.nuke-code');
                if (codes.length >= 3) {
                    document.querySelector('#nukeCodesContent p:last-child').innerHTML = 
                        `<strong>Alpha:</strong> ${codes[0].textContent}<br>` +
                        `<strong>Bravo:</strong> ${codes[1].textContent}<br>` +
                        `<strong>Charlie:</strong> ${codes[2].textContent}`;
                }
            }).catch(() => {});
    }, 3600000);

})();
    /* --------------------------------------------------------------------------
   Fallout 76 Item Finder Map Version 30 - Disclaimer and Terms of Use
   --------------------------------------------------------------------------
   Copyright (c) 2025 MrCrazy. All rights reserved.

   This application, including all code, design, content, and the map images, is the intellectual property of MrCrazy.
   Unauthorized use, copying, modification, distribution, or monetization of this application or any part thereof is strictly prohibited without explicit written permission from the author.

   This app is provided "as is" for personal, non-commercial use by Fallout 76 players to track in-game items.
   The author is not responsible for any damages or losses resulting from the use of this application. Use at your own risk.

   For inquiries or permission requests, call someone who cares.

   Last updated: October 24, 2025
   -------------------------------------------------------------------------- */
</script>
</body>
</html>
